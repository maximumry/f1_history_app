<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.f1.f1history.dao.DriverInfoMapper">
    
    <resultMap type="com.f1.f1history.entity.Driver" id="driverMap">
        <id column="driver_id" property="driverId"/>
        <result column="team" property="team"/>
        <result column="world_championships" property="worldChampionships"/>
        <result column="wins" property="wins"/>
        <result column="wiki_url" property="wikiUrl"/>
        <result column="user_id" property="userId"/>
        <association property="user" resultMap="userMap" />
        <collection property="eventList" resultMap="eventMap" columnPrefix="events_"/>
    </resultMap>
    
    <resultMap type="com.f1.f1history.entity.MUser" id="userMap">
    	<id column="user_id" property="userId"/>
    	<result column="name" property="name" />
    	<result column="password" property="password"/>
    	<result column="role" property="role"/>
    	<result column="created_at" property="createdAt"/>
    	<result column="email" property="email"/>
    </resultMap>
    
    <!-- Eventのマッピング -->
    <resultMap type="com.f1.f1history.entity.Event" id="eventMap">
        <id column="event_id" property="eventId"/>
	    <result column="driver_id" property="driverId"/>
	    <result column="description" property="description"/>
	    <result column="date" property="date"/>
	    <result column="category" property="category"/>
	    <result column="title" property="title"/>
	    <result column="youtube_url" property="youtubeUrl"/>
	    <result column="weather_condition" property="weatherCondition" />
    </resultMap>

    <!-- 全てのDriverを取得 -->
    <select id="getAllDriver" resultMap="driverMap">
        SELECT * FROM drivers
    </select>

    <!-- Driverを挿入 -->
    <insert id="insertDriver">
        INSERT INTO drivers(
            driver_id
            ,user_id
            ,wins
            ,wiki_url
            ,team
            ,world_championships)
        VALUES(
            #{driverId}
            ,#{userId}
            ,#{wins}
            ,#{wikiUrl}
            ,#{team}
            ,#{worldChampionships})
    </insert>
    
    <select id="getDriver" resultMap="driverMap">
    	SELECT
    		drivers.driver_id
    		,drivers.team
    		,drivers.world_championships
    		,drivers.wins
    		,drivers.wiki_url
    		,drivers.user_id
    		,events.event_id as events_event_id
    		,events.description as events_description
    		,events.date as events_date
    		,events.category as events_category
    		,events.weather_condition as events_weather_condition
    		,events.title as events_title
    		,events.youtube_url as events_youtube_url
    	FROM drivers
    	LEFT JOIN
    		events
    	ON drivers.driver_id = events.driver_id
    	<!-- and 1 != 1 -->
    	WHERE drivers.driver_id = #{driverId}
    </select>

    <!-- 特定のDriverを取得
    <select id="getDriver" resultMap="driverMap">
        SELECT
        	drivers.name,
        	drivers.country,
        	drivers.date_of_birth,
        	drivers.place_of_birth,
        	events.event_id as events_event_id,
        	events.description as events_description,
        	events.date as events_date,
        	events.category as events_category
        FROM
        	drivers
        LEFT JOIN
        	events
        ON drivers.driver_id = events.driver_id
        WHERE
        	drivers.driver_id = #{driverId}
    </select> -->

    <!-- Driverを更新 -->
    <update id="updateDriver">
        UPDATE drivers
        SET
            driver_id = #{driver.driverId}
            ,user_id = #{driver.userId}
            ,wins = #{driver.wins}
            ,wiki_url = #{driver.wikiUrl}
            ,world_championships = #{driver.worldChampionships}
            ,team = #{driver.team}
        WHERE
            driver_id = #{driver.driverId}
    </update>

    <!-- Driverを削除 -->
    <delete id="deleteDriver">
        DELETE FROM drivers WHERE driver_id = #{driverId}
    </delete>
    
    <select id="searchDriver" resultMap="driverMap">
    	SELECT
    		drivers.driver_id,
    		drivers.name,
        	drivers.country,
        	drivers.date_of_birth,
        	drivers.place_of_birth,
        	events.event_id as events_event_id,
        	events.description as events_description,
        	events.date as events_date,
        	events.category as events_category
        FROM
        	drivers
        LEFT JOIN
        	events
        ON drivers.driver_id = events.driver_id
        <where>
        	<if test="name != null">
        		AND drivers.name LIKE CONCAT('%', #{name}, '%')
        	</if>
        </where>
    </select>
</mapper>